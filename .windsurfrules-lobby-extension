# Extension des rÃ¨gles Windsurf pour le systÃ¨me de lobbies temps rÃ©el
# Ã€ intÃ©grer dans le fichier .windsurfrules principal

# RÃ¨gles spÃ©cifiques pour l'architecture lobby temps rÃ©el avec Transmit
lobby_realtime_rules:
  - name: "Hybrid Inertia+Transmit Architecture"
    description: |
      Architecture hybride obligatoire pour les lobbies temps rÃ©el :
      - Inertia.js fournit les donnÃ©es initiales (affichage immÃ©diat)
      - Transmit gÃ¨re les mises Ã  jour temps rÃ©el uniquement
      - Fallback gracieux si Transmit Ã©choue
      - Jamais de duplication entre les deux sources
    checks:
      - VÃ©rifier que les pages lobby reÃ§oivent des props Inertia (initialLobby, currentUser)
      - S'assurer que les hooks utilisent les donnÃ©es Inertia comme fallback
      - ContrÃ´ler que Transmit ne remplace jamais complÃ¨tement Inertia
      - VÃ©rifier la logique : `const effectiveLobby = realtimeLobby || initialLobby`
    autofix: |
      Ajouter les props Inertia manquantes dans les contrÃ´leurs
      ImplÃ©menter le pattern de fallback dans les hooks
      Corriger les accÃ¨s directs Ã  Transmit sans fallback Inertia

  - name: "Mandatory Timeout Protection"
    description: |
      Protection timeout obligatoire de 10 secondes sur tous les composants avec Ã©tat de chargement.
      PrÃ©vient les loading infinis et amÃ©liore l'UX.
    checks:
      - VÃ©rifier que tout useState avec loading a un timeout de 10s
      - S'assurer que le timeout dÃ©clenche un fallback appropriÃ©
      - ContrÃ´ler la prÃ©sence de cleanup dans les useEffect
      - VÃ©rifier les logs de timeout avec prÃ©fixes appropriÃ©s
    autofix: |
      Ajouter automatiquement le pattern de timeout :
      ```typescript
      const [timeoutReached, setTimeoutReached] = useState(false)
      useEffect(() => {
        if (loading && !timeoutReached) {
          const timeout = setTimeout(() => {
            console.warn('ðŸŽ¯ Component: Timeout reached')
            setTimeoutReached(true)
            // Fallback action
          }, 10000)
          return () => clearTimeout(timeout)
        }
      }, [loading, timeoutReached])
      ```

  - name: "Standardized Logging Prefixes"
    description: |
      Logging standardisÃ© avec prÃ©fixes obligatoires pour traÃ§abilitÃ© :
      - ðŸŽ® Pages lobby
      - ðŸ”§ Composants lobby  
      - ðŸ“¡ Services Transmit
      - ðŸŽ¯ Hooks lobby
    checks:
      - VÃ©rifier que tous les console.log utilisent les bons prÃ©fixes
      - S'assurer que les logs incluent le contexte (lobbyUuid, userUuid)
      - ContrÃ´ler la cohÃ©rence des messages de log
    autofix: |
      Remplacer console.log() par console.log('ðŸŽ® ComponentName: Message', context)
      Ajouter le contexte manquant dans les logs existants

  - name: "Board Game Arena State Management"
    description: |
      Ã‰tats de lobby standardisÃ©s Board Game Arena avec transitions validÃ©es :
      WAITING â†’ READY â†’ FULL â†’ STARTING â†’ IN_GAME â†’ PAUSED/FINISHED
      Utilisation obligatoire des constantes LOBBY_STATUS et validateLobbyTransition()
    checks:
      - VÃ©rifier que tous les Ã©tats utilisent les constantes LOBBY_STATUS
      - S'assurer que les transitions sont validÃ©es avec validateLobbyTransition()
      - ContrÃ´ler que les composants gÃ¨rent tous les Ã©tats possibles
      - VÃ©rifier les couleurs et textes appropriÃ©s pour chaque Ã©tat
    autofix: |
      Remplacer les strings hardcodÃ©es par LOBBY_STATUS.WAITING
      Ajouter la validation de transition avant changement d'Ã©tat
      ImplÃ©menter les handlers manquants pour les nouveaux Ã©tats

  - name: "Granular Permissions System"
    description: |
      SystÃ¨me de permissions granulaire obligatoire avec getLobbyPermissions().
      Toutes les actions utilisateur doivent vÃ©rifier les permissions avant exÃ©cution.
    checks:
      - VÃ©rifier que toutes les actions utilisent getLobbyPermissions()
      - S'assurer que les boutons sont conditionnels selon les permissions
      - ContrÃ´ler que les permissions sont recalculÃ©es lors des changements
      - VÃ©rifier les messages d'erreur appropriÃ©s si permission refusÃ©e
    autofix: |
      Ajouter const permissions = getLobbyPermissions(lobby, currentUser)
      Rendre les actions conditionnelles : {permissions?.canJoin && <Button />}
      Ajouter les vÃ©rifications de permissions dans les handlers

  - name: "Immutable State Updates"
    description: |
      ImmutabilitÃ© stricte obligatoire pour tous les Ã©tats lobby.
      Interdiction absolue des mutations directes (push, splice, etc.)
    checks:
      - Interdire lobby.players.push(), state.loading = false, etc.
      - VÃ©rifier l'utilisation de spread operator et mÃ©thodes immutables
      - S'assurer que les services notifient avec des copies immutables
      - ContrÃ´ler que React dÃ©tecte bien les changements d'Ã©tat
    autofix: |
      Remplacer lobby.players.push(player) par 
      setLobby(prev => ({...prev, players: [...prev.players, player]}))
      Ajouter des copies immutables dans les services

  - name: "Throttled Real-time Updates"
    description: |
      Throttling obligatoire des mises Ã  jour temps rÃ©el (max 10/seconde).
      PrÃ©vient les re-renders excessifs et amÃ©liore les performances.
    checks:
      - VÃ©rifier la prÃ©sence de throttling dans tous les hooks temps rÃ©el
      - S'assurer d'un dÃ©lai minimum de 100ms entre les mises Ã  jour
      - ContrÃ´ler l'utilisation de useRef pour le timestamp
      - VÃ©rifier les logs de throttling
    autofix: |
      Ajouter le pattern de throttling :
      ```typescript
      const lastUpdateRef = useRef(Date.now())
      const handleUpdate = (newState) => {
        const now = Date.now()
        if (now - lastUpdateRef.current > 100) {
          setState(newState)
          lastUpdateRef.current = now
        }
      }
      ```

  - name: "Context-based Service Access"
    description: |
      AccÃ¨s aux services uniquement via contexte React.
      Interdiction des imports directs de services dans les composants.
    checks:
      - Interdire import { lobbyService } from '../services/lobby_service'
      - VÃ©rifier l'utilisation de const { lobbyService } = useLobbyContext()
      - S'assurer que tous les services passent par le contexte
      - ContrÃ´ler la gestion des services null/undefined
    autofix: |
      Remplacer les imports directs par l'utilisation du contexte
      Ajouter les vÃ©rifications de nullitÃ© : if (!lobbyService) return

  - name: "Transmit Event Handling"
    description: |
      Gestion standardisÃ©e des Ã©vÃ©nements Transmit avec types stricts.
      Ã‰vÃ©nements obligatoires : lobby.created, lobby.updated, lobby.player.joined/left, etc.
    checks:
      - VÃ©rifier que tous les Ã©vÃ©nements utilisent LobbyTransmitEvent
      - S'assurer de la gestion de tous les types d'Ã©vÃ©nements
      - ContrÃ´ler la structure des donnÃ©es d'Ã©vÃ©nement
      - VÃ©rifier les logs d'Ã©vÃ©nements avec contexte
    autofix: |
      Ajouter les handlers manquants pour les nouveaux types d'Ã©vÃ©nements
      Typer les Ã©vÃ©nements avec LobbyTransmitEvent
      Ajouter les logs standardisÃ©s pour chaque Ã©vÃ©nement

  - name: "Error Handling with Toast Integration"
    description: |
      Gestion d'erreurs avec BusinessException et toasts automatiques.
      Toutes les actions lobby doivent gÃ©rer les erreurs avec feedback utilisateur.
    checks:
      - VÃ©rifier que les actions utilisent try/catch avec toast
      - S'assurer de l'utilisation de BusinessException cÃ´tÃ© backend
      - ContrÃ´ler les messages d'erreur utilisateur appropriÃ©s
      - VÃ©rifier les logs d'erreur avec contexte complet
    autofix: |
      Ajouter le pattern de gestion d'erreur :
      ```typescript
      try {
        await action()
        toast.success('Action rÃ©ussie')
      } catch (error) {
        console.error('ðŸ”§ Component: Action failed', error)
        toast.error('Erreur lors de l\'action')
      }
      ```

  - name: "Lobby Action Validation"
    description: |
      Validation obligatoire des actions lobby cÃ´tÃ© client et serveur.
      VÃ©rification des permissions, Ã©tats et donnÃ©es avant exÃ©cution.
    checks:
      - VÃ©rifier la validation des permissions avant chaque action
      - S'assurer de la validation des Ã©tats de lobby appropriÃ©s
      - ContrÃ´ler la validation des donnÃ©es utilisateur (UUID, etc.)
      - VÃ©rifier les messages d'erreur explicites en cas d'Ã©chec
    autofix: |
      Ajouter les validations manquantes dans les handlers d'action
      ImplÃ©menter les vÃ©rifications d'Ã©tat de lobby
      Ajouter les validations de donnÃ©es utilisateur

# Patterns d'implÃ©mentation recommandÃ©s
lobby_patterns:
  page_structure: |
    ```typescript
    export default function LobbyPage({ initialLobby, currentUser }: Props) {
      console.log('ðŸŽ® LobbyPage: Initializing', { lobbyUuid: initialLobby?.uuid })
      
      const { lobby, loading, error } = useLobbyDetails(initialLobby?.uuid || '')
      const [timeoutReached, setTimeoutReached] = useState(false)
      
      // Timeout protection obligatoire
      useEffect(() => {
        if (loading && !timeoutReached) {
          const timeout = setTimeout(() => {
            console.warn('ðŸŽ® LobbyPage: Timeout reached')
            setTimeoutReached(true)
          }, 10000)
          return () => clearTimeout(timeout)
        }
      }, [loading, timeoutReached])
      
      const effectiveLobby = lobby || initialLobby
      const permissions = currentUser ? getLobbyPermissions(effectiveLobby, currentUser) : null
      
      return (
        <div>
          {/* Composants avec permissions */}
        </div>
      )
    }
    ```

  hook_structure: |
    ```typescript
    export function useLobbyDetails(lobbyUuid: string) {
      console.log('ðŸŽ¯ useLobbyDetails: Initializing', { lobbyUuid })
      
      const { lobbyService } = useLobbyContext()
      const [state, setState] = useState<LobbyDetailState>({
        lobby: null,
        loading: true,
        error: null
      })
      const [timeoutReached, setTimeoutReached] = useState(false)
      const lastUpdateRef = useRef(Date.now())
      
      // Timeout + Throttling + Cleanup obligatoires
      
      return { ...state, timeoutReached }
    }
    ```

  service_structure: |
    ```typescript
    export class LobbyService {
      private subscribers = new Set<(state: LobbyState) => void>()
      
      private notifySubscribers(newState: LobbyState) {
        console.log('ðŸ“¡ LobbyService: Notifying subscribers')
        // Copie immutable obligatoire
        const immutableState = { ...newState }
        this.subscribers.forEach(callback => callback(immutableState))
      }
      
      updateLobby(lobby: Lobby) {
        console.log('ðŸ“¡ LobbyService: Updating lobby', { lobbyUuid: lobby.uuid })
        // Mise Ã  jour immutable
        this.currentState = {
          ...this.currentState,
          lobby: { ...lobby }
        }
        this.notifySubscribers(this.currentState)
      }
    }
    ```

  action_handler_structure: |
    ```typescript
    const handleLobbyAction = async () => {
      if (!permissions?.canAction) {
        console.warn('ðŸ”§ Component: Cannot perform action - no permission')
        toast.warning('Action non autorisÃ©e')
        return
      }
      
      console.log('ðŸ”§ Component: Performing action', { lobbyUuid, userUuid })
      setLoading(true)
      
      try {
        await lobbyService.performAction(lobbyUuid, userUuid)
        console.log('ðŸ”§ Component: Action successful')
        toast.success('Action rÃ©alisÃ©e avec succÃ¨s')
      } catch (error) {
        console.error('ðŸ”§ Component: Action failed', error)
        toast.error('Erreur lors de l\'action')
      } finally {
        setLoading(false)
      }
    }
    ```

# Checklist d'implÃ©mentation automatique
lobby_implementation_checklist:
  - "âœ… Props Inertia (initialLobby, currentUser) dans toutes les pages lobby"
  - "âœ… Timeout de 10 secondes sur tous les Ã©tats de chargement"
  - "âœ… Logging avec prÃ©fixes standardisÃ©s (ðŸŽ®ðŸ”§ðŸ“¡ðŸŽ¯)"
  - "âœ… Fallback gracieux : effectiveLobby = realtimeLobby || initialLobby"
  - "âœ… Permissions calculÃ©es avec getLobbyPermissions()"
  - "âœ… Actions conditionnelles basÃ©es sur les permissions"
  - "âœ… Ã‰tats LOBBY_STATUS avec transitions validÃ©es"
  - "âœ… ImmutabilitÃ© stricte dans toutes les mises Ã  jour"
  - "âœ… Throttling des mises Ã  jour temps rÃ©el (100ms min)"
  - "âœ… AccÃ¨s aux services via contexte uniquement"
  - "âœ… Gestion d'erreurs avec toast feedback"
  - "âœ… Cleanup des souscriptions dans useEffect"
  - "âœ… Ã‰vÃ©nements Transmit typÃ©s avec LobbyTransmitEvent"
  - "âœ… Validation des actions cÃ´tÃ© client et serveur"
